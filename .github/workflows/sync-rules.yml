name: Sync Rules from HaGeZi
on:
  schedule:
    - cron: '5 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  sync-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Sync and Update Rules
        id: sync
        run: |
          mkdir -p rules logs
          
          declare -A rules=(
            ["pro.mini"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/pro.mini.txt"
            ["tif.medium"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/tif.medium.txt"
            ["spam-tlds"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/spam-tlds.txt"
          )
          
          echo "ðŸ”„ å¼€å§‹åŒæ­¥è§„åˆ™..."
          any_rule_updated=false
          for rule in "${!rules[@]}"; do
            echo "ðŸ“¥ åŒæ­¥ ${rule}..."
            url="${rules[$rule]}"
            output_file="rules/${rule}.txt"
            temp_file="rules/${rule}.tmp.txt"
            
            success=false
            for i in {1..3}; do
              if curl -s -L --retry 2 --max-time 30 -o "$temp_file" "$url" && [[ -s "$temp_file" ]]; then
                success=true
                break
              else
                echo "âš ï¸ ç¬¬ $i æ¬¡å°è¯•å¤±è´¥ï¼Œ5ç§’åŽé‡è¯•..."
                sleep 5
              fi
            done
            
            if [[ "$success" != true ]]; then
              echo "âŒ æ— æ³•ä¸‹è½½ ${rule}ï¼Œè·³è¿‡"
              rm -f "$temp_file" 2>/dev/null
              continue
            fi
            
            if [[ -f "$output_file" ]] && cmp -s "$output_file" "$temp_file"; then
              echo "âœ… ${rule}: æ— å˜åŒ–"
              rm "$temp_file"
            else
              echo "âœ¨ ${rule}: æ£€æµ‹åˆ°æ›´æ–°"
              mv "$temp_file" "$output_file"
              any_rule_updated=true
            fi
          done
          
          CURRENT_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          NEXT_SYNC=$(date -u -d '+1 hour' +"%Y-%m-%d %H:%M:%S UTC")
          
          count_entries() {
            [[ -f "$1" ]] && grep -v -E '^[[:space:]]*!|^[[:space:]]*$' "$1" | wc -l | tr -d ' ' || echo "0"
          }
          
          PRO_COUNT=$(count_entries "rules/pro.mini.txt")
          TIF_COUNT=$(count_entries "rules/tif.medium.txt")
          SPAM_COUNT=$(count_entries "rules/spam-tlds.txt")
          
          # ðŸ”‘ æ ¸å¿ƒä¿®å¤ï¼šå½»åº•å®‰å…¨çš„sedå‘½ä»¤ï¼ˆä½¿ç”¨^åˆ†éš”ç¬¦ + ç²¾ç¡®è½¬ä¹‰|ï¼‰
          if [[ -f "README.md" ]]; then
            sed -i "s^\\| pro\\.mini\\.txt \\|.*^\\| pro.mini.txt \\| $CURRENT_TIME \\| $PRO_COUNT \\|^" README.md
            sed -i "s^\\| tif\\.medium\\.txt \\|.*^\\| tif.medium.txt \\| $CURRENT_TIME \\| $TIF_COUNT \\|^" README.md
            sed -i "s^\\| spam-tlds\\.txt \\|.*^\\| spam-tlds.txt \\| $CURRENT_TIME \\| $SPAM_COUNT \\|^" README.md
            sed -i "s^æœ€åŽåŒæ­¥æ—¶é—´:.*^æœ€åŽåŒæ­¥æ—¶é—´: $CURRENT_TIME^" README.md
            sed -i "s^ä¸‹æ¬¡åŒæ­¥:.*^ä¸‹æ¬¡åŒæ­¥: $NEXT_SYNC^" README.md
            echo "âœ… README.md å·²æ›´æ–°"
          else
            # ðŸ”‘ æ ¸å¿ƒä¿®å¤ï¼šç”¨printfå®‰å…¨ç”ŸæˆREADMEï¼ˆæ— EOFé—®é¢˜ï¼‰
            printf '# ðŸ›¡ï¸ AdGuardè§„åˆ™åŒæ­¥ä»“åº“\n\næœ¬é¡¹ç›®è‡ªåŠ¨åŒæ­¥HaGeZiæŽ¨èçš„ä¼˜åŒ–ç‰ˆAdGuardè§„åˆ™ï¼Œé€‚ç”¨äºŽAdGuard Homeã€AdGuard for Windows/macOSç­‰ã€‚\n\n## ðŸ“¦ åŒ…å«è§„åˆ™\n\n| è§„åˆ™ | ç‰ˆæœ¬ | æŽ¨èç”¨é€” | RAWé“¾æŽ¥ |\n|------|------|----------|---------|\n| Proåˆ—è¡¨ | miniç‰ˆ | å¹¿å‘Šã€è·Ÿè¸ªå™¨æ‹¦æˆª | [ç‚¹å‡»å¤åˆ¶](https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/rules/pro.mini.txt) |\n| TIFåˆ—è¡¨ | mediumç‰ˆ | å¨èƒã€æ¶æ„è½¯ä»¶æ‹¦æˆª | [ç‚¹å‡»å¤åˆ¶](https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/rules/tif.medium.txt) |\n| Spam TLDs | å®Œæ•´ç‰ˆ | æ»¥ç”¨é¡¶çº§åŸŸåæ‹¦æˆª | [ç‚¹å‡»å¤åˆ¶](https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/rules/spam-tlds.txt) |\n\n## ðŸš€ ä½¿ç”¨æ–¹æ³•\n\nåœ¨AdGuard Homeä¸­ï¼š\n1. è¿›å…¥ **è¿‡æ»¤å™¨** â†’ **DNSå°é”æ¸…å•**\n2. ç‚¹å‡» **æ·»åŠ é˜»æ­¢åˆ—è¡¨**\n3. ç²˜è´´ä¸Šæ–¹RAWé“¾æŽ¥\n4. è®¾ç½®æ›´æ–°é—´éš”ï¼ˆå»ºè®®24å°æ—¶ï¼‰\n\n## ðŸ”„ åŒæ­¥çŠ¶æ€\n\n**æœ€åŽåŒæ­¥æ—¶é—´:** $CURRENT_TIME\n**ä¸‹æ¬¡åŒæ­¥:** $NEXT_SYNC\n**ä»“åº“æ´»è·ƒçŠ¶æ€:** âœ… æ­£å¸¸\n\n## ðŸ“Š è§„åˆ™ç»Ÿè®¡\n\n| è§„åˆ™ | æœ€åŽæ›´æ–° | æ¡ç›®æ•° |\n|------|----------|--------|\n| pro.mini.txt | $CURRENT_TIME | $PRO_COUNT |\n| tif.medium.txt | $CURRENT_TIME | $TIF_COUNT |\n| spam-tlds.txt | $CURRENT_TIME | $SPAM_COUNT |\n\n## âš™ï¸ æŠ€æœ¯ç»†èŠ‚\n\n- **åŒæ­¥é¢‘çŽ‡:** æ¯å°æ—¶ä¸€æ¬¡\n- **å¤±è´¥é‡è¯•:** 3æ¬¡\n- **ç›‘æŽ§:** GitHub Actionsè‡ªåŠ¨ç›‘æŽ§\n\n---\n*è‡ªåŠ¨åŒæ­¥è‡ª [HaGeZi\'s DNS Blocklists](https://github.com/hagezi/dns-blocklists)*\n' > README.md
            echo "âœ… README.md å·²åˆ›å»º"
          fi
          
          cat > sync-status.txt << EOF
æœ€åŽåŒæ­¥: $CURRENT_TIME
ä¸‹æ¬¡åŒæ­¥: $NEXT_SYNC
è§„åˆ™ç»Ÿè®¡:
- pro.mini.txt: $PRO_COUNT æ¡
- tif.medium.txt: $TIF_COUNT æ¡
- spam-tlds.txt: $SPAM_COUNT æ¡
ç”ŸæˆäºŽ: $CURRENT_TIME
EOF
          
          echo "[$(date -u +'%Y-%m-%d %H:%M:%S UTC')] åŒæ­¥å®Œæˆ" >> "logs/sync-$(date -u +'%Y-%m-%d').log"
          
          if [[ "$any_rule_updated" = true ]]; then
            echo "update_type=rules_and_status" >> "$GITHUB_OUTPUT"
          else
            echo "update_type=status_only" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and Push Changes
        if: steps.sync.outputs.update_type == 'rules_and_status' || steps.sync.outputs.update_type == 'status_only'
        run: |
          git config user.name 'GitHub Actions Bot'
          git config user.email 'actions@github.com'
          git add rules/ README.md sync-status.txt logs/
          
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ— å†…å®¹æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          COMMIT_MSG="$(if [[ "${{ steps.sync.outputs.update_type }}" == "rules_and_status" ]]; then echo "ðŸ¤– åŒæ­¥è§„åˆ™æ›´æ–°"; else echo "ðŸ“Š æ›´æ–°åŒæ­¥çŠ¶æ€"; fi) - $(date -u +'%Y-%m-%d %H:%M UTC')"
          git commit -m "$COMMIT_MSG" && git push || echo "âš ï¸ æäº¤/æŽ¨é€å¤±è´¥"

      - name: Generate Summary Report
        if: always()
        run: |
          echo "## ðŸ“Š åŒæ­¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ -f "sync-status.txt" ]]; then
            LAST_SYNC=$(grep "æœ€åŽåŒæ­¥:" sync-status.txt | cut -d':' -f2- | xargs)
            NEXT_SYNC=$(grep "ä¸‹æ¬¡åŒæ­¥:" sync-status.txt | cut -d':' -f2- | xargs)
            PRO_COUNT=$(grep "pro.mini.txt:" sync-status.txt | grep -o '[0-9]\+' | head -1)
            TIF_COUNT=$(grep "tif.medium.txt:" sync-status.txt | grep -o '[0-9]\+' | head -1)
            SPAM_COUNT=$(grep "spam-tlds.txt:" sync-status.txt | grep -o '[0-9]\+' | head -1)
            
            echo "- **âœ… æœ€åŽåŒæ­¥**: $LAST_SYNC" >> $GITHUB_STEP_SUMMARY
            echo "- **ðŸ• ä¸‹æ¬¡åŒæ­¥**: $NEXT_SYNC" >> $GITHUB_STEP_SUMMARY
            echo "- **ðŸ“¦ Pro Mini**: $PRO_COUNT æ¡" >> $GITHUB_STEP_SUMMARY
            echo "- **ðŸ›¡ï¸ TIF Medium**: $TIF_COUNT æ¡" >> $GITHUB_STEP_SUMMARY
            echo "- **ðŸ“§ Spam TLDs**: $SPAM_COUNT æ¡" >> $GITHUB_STEP_SUMMARY
            echo "- **ðŸ”„ æ›´æ–°ç±»åž‹**: ${{ steps.sync.outputs.update_type }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ çŠ¶æ€æ–‡ä»¶ç¼ºå¤±" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ ä»“åº“å˜æ›´" >> $GITHUB_STEP_SUMMARY
          git status --short 2>/dev/null | head -5 >> $GITHUB_STEP_SUMMARY || echo "æ— å˜æ›´" >> $GITHUB_STEP_SUMMARY
