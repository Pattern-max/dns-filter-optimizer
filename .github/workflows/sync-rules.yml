name: Sync Rules from HaGeZi
on:
  schedule:
    # æ¯å°æ—¶çš„ç¬¬5åˆ†é’Ÿè¿è¡Œï¼ˆé¿å…æ•´ç‚¹é«˜å³°ï¼‰
    - cron: '5 * * * *'
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  sync-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Sync Rules
        run: |
          # åˆ›å»ºè§„åˆ™ç›®å½•
          mkdir -p rules logs
          
          # å®šä¹‰è§„åˆ™æº
          declare -A rules=(
            ["pro.mini"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/pro.mini.txt"
            ["tif.medium"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/tif.medium.txt"
            ["spam-tlds"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/spam-tlds.txt"
          )
          
          # åŒæ­¥æ¯ä¸ªè§„åˆ™
          updated=false
          for rule in "${!rules[@]}"; do
            echo "Syncing ${rule}..."
            url="${rules[$rule]}"
            
            # ä¸‹è½½è§„åˆ™ï¼Œå¸¦é‡è¯•æœºåˆ¶
            for i in {1..3}; do
              if curl -s -L --retry 3 --max-time 30 -o "rules/${rule}.tmp.txt" "$url"; then
                break
              else
                echo "Attempt $i failed, retrying..."
                sleep 5
              fi
            done
            
            # æ¯”è¾ƒæ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
            if [[ -f "rules/${rule}.txt" ]] && cmp -s "rules/${rule}.txt" "rules/${rule}.tmp.txt"; then
              echo "No changes for ${rule}"
              rm "rules/${rule}.tmp.txt"
            else
              echo "Updating ${rule}"
              mv "rules/${rule}.tmp.txt" "rules/${rule}.txt"
              updated=true
            fi
          done
          
          # å¦‚æžœæœ‰æ›´æ–°ï¼Œæäº¤æ›´æ”¹
          if [[ "$updated" = true ]]; then
            # æ›´æ–°åŒæ­¥æ—¶é—´æˆ³
            date -u +"%Y-%m-%d %H:%M:%S UTC" > update-timestamp.txt
            
            # é…ç½®git
            git config --global user.name 'GitHub Actions Bot'
            git config --global user.email 'actions@github.com'
            
            # æ·»åŠ ã€æäº¤å’ŒæŽ¨é€
            git add rules/ update-timestamp.txt
            git commit -m "ðŸ¤– Sync rules - $(date -u +'%Y-%m-%d %H:%M')"
            git push
          else
            echo "No updates needed"
          fi
          
          # è®°å½•æ—¥å¿—
          echo "Sync completed at $(date)" >> logs/sync-$(date +%Y-%m-%d).log

      - name: Generate Status Report
        if: always()
        run: |
          echo "## ðŸ“Š Sync Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Last Sync:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Pro Mini Rules:** $(wc -l < rules/pro.mini.txt 2>/dev/null || echo '0') entries" >> $GITHUB_STEP_SUMMARY
          echo "- **TIF Medium Rules:** $(wc -l < rules/tif.medium.txt 2>/dev/null || echo '0') entries" >> $GITHUB_STEP_SUMMARY
          echo "- **Spam TLDs:** $(wc -l < rules/spam-tlds.txt 2>/dev/null || echo '0') entries" >> $GITHUB_STEP_SUMMARY
