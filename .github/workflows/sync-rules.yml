name: Sync Rules from HaGeZi
on:
  schedule:
    # æ¯å°æ—¶çš„ç¬¬5åˆ†é’Ÿè¿è¡Œï¼ˆé¿å…æ•´ç‚¹é«˜å³°ï¼‰
    - cron: '5 * * * *'
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

# ðŸ” å¹¶å‘æŽ§åˆ¶ï¼šé˜²æ­¢åŒä¸€åˆ†æ”¯ä¸Šå¤šä¸ªå·¥ä½œæµåŒæ—¶è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  sync-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Sync and Update
        id: sync
        run: |
          # åˆ›å»ºç›®å½•
          mkdir -p rules logs
          
          # å®šä¹‰è§„åˆ™æº
          declare -A rules=(
            ["pro.mini"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/pro.mini.txt"
            ["tif.medium"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/tif.medium.txt"
            ["spam-tlds"]="https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/spam-tlds.txt"
          )
          
          # 1. åŒæ­¥è§„åˆ™æ–‡ä»¶
          echo "å¼€å§‹åŒæ­¥è§„åˆ™..."
          any_rule_updated=false
          for rule in "${!rules[@]}"; do
            echo "æ­£åœ¨åŒæ­¥ ${rule}..."
            url="${rules[$rule]}"
            output_file="rules/${rule}.txt"
            temp_file="rules/${rule}.tmp.txt"
            
            # ä¸‹è½½è§„åˆ™ï¼Œå¸¦é‡è¯•æœºåˆ¶
            success=false
            for i in {1..3}; do
              if curl -s -L --retry 2 --max-time 30 -o "$temp_file" "$url" && [[ -s "$temp_file" ]]; then
                success=true
                break
              else
                echo "ç¬¬ $i æ¬¡å°è¯•å¤±è´¥ï¼Œ5ç§’åŽé‡è¯•..."
                sleep 5
              fi
            done
            
            if [[ "$success" != true ]]; then
              echo "é”™è¯¯: æ— æ³•ä¸‹è½½ ${rule} è§„åˆ™ï¼Œè·³è¿‡æ­¤è§„åˆ™ã€‚"
              rm -f "$temp_file"
              continue
            fi
            
            # æ¯”è¾ƒæ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
            if [[ -f "$output_file" ]] && cmp -s "$output_file" "$temp_file"; then
              echo "${rule}: æ— å˜åŒ–"
              rm "$temp_file"
            else
              echo "${rule}: æ£€æµ‹åˆ°æ›´æ–°"
              mv "$temp_file" "$output_file"
              any_rule_updated=true
            fi
          done
          
          # 2. æ— è®ºè§„åˆ™æ˜¯å¦æ›´æ–°ï¼Œéƒ½å‡†å¤‡ç”Ÿæˆæœ€æ–°çŠ¶æ€
          echo "å‡†å¤‡æ›´æ–°çŠ¶æ€ä¿¡æ¯..."
          CURRENT_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          NEXT_SYNC=$(date -u -d '+1 hour' +"%Y-%m-%d %H:%M:%S UTC")
          
          # ç»Ÿè®¡å®žé™…æ¡ç›®æ•°ï¼ˆæŽ’é™¤æ³¨é‡Šè¡Œå’Œç©ºè¡Œï¼‰
          count_entries() {
            local file=$1
            if [[ -f "$file" ]]; then
              grep -v -E '^[[:space:]]*!|^[[:space:]]*$' "$file" | wc -l || echo "0"
            else
              echo "0"
            fi
          }
          
          PRO_COUNT=$(count_entries "rules/pro.mini.txt")
          TIF_COUNT=$(count_entries "rules/tif.medium.txt")
          SPAM_COUNT=$(count_entries "rules/spam-tlds.txt")
          
          # 3. æ›´æ–°æˆ–åˆ›å»º README.md
          if [[ -f "README.md" ]]; then
            # æ›´æ–°çŽ°æœ‰README
            sed -i "s/æœ€åŽåŒæ­¥æ—¶é—´:.*/æœ€åŽåŒæ­¥æ—¶é—´: $CURRENT_TIME/" README.md
            sed -i "s/ä¸‹æ¬¡åŒæ­¥:.*/ä¸‹æ¬¡åŒæ­¥: $NEXT_SYNC/" README.md
            sed -i "s/| pro.mini.txt |.*|/| pro.mini.txt | $CURRENT_TIME | $PRO_COUNT |/" README.md
            sed -i "s/| tif.medium.txt |.*|/| tif.medium.txt | $CURRENT_TIME | $TIF_COUNT |/" README.md
            sed -i "s/| spam-tlds.txt |.*|/| spam-tlds.txt | $CURRENT_TIME | $SPAM_COUNT |/" README.md
            echo "README.md å·²æ›´æ–°"
          else
            # åˆ›å»ºæ–°çš„README
            echo "åˆ›å»º README.md..."
            cat > README.md << EOF
# ðŸ›¡ï¸ AdGuardè§„åˆ™åŒæ­¥ä»“åº“

æœ¬é¡¹ç›®è‡ªåŠ¨åŒæ­¥HaGeZiæŽ¨èçš„ä¼˜åŒ–ç‰ˆAdGuardè§„åˆ™ï¼Œé€‚ç”¨äºŽAdGuard Homeã€‚

## ðŸ“¦ åŒ…å«è§„åˆ™

| è§„åˆ™ | ç‰ˆæœ¬ | æŽ¨èç”¨é€” | RAWé“¾æŽ¥ |
|------|------|----------|---------|
| Proåˆ—è¡¨ | miniç‰ˆ | å¹¿å‘Šã€è·Ÿè¸ªå™¨æ‹¦æˆª | [ç‚¹å‡»å¤åˆ¶](https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/rules/pro.mini.txt) |
| TIFåˆ—è¡¨ | mediumç‰ˆ | å¨èƒã€æ¶æ„è½¯ä»¶æ‹¦æˆª | [ç‚¹å‡»å¤åˆ¶](https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/rules/tif.medium.txt) |
| Spam TLDs | å®Œæ•´ç‰ˆ | æ»¥ç”¨é¡¶çº§åŸŸåæ‹¦æˆª | [ç‚¹å‡»å¤åˆ¶](https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/rules/spam-tlds.txt) |

## ðŸš€ ä½¿ç”¨æ–¹æ³•

åœ¨AdGuard Homeä¸­ï¼š
1. è¿›å…¥ **è¿‡æ»¤å™¨** â†’ **DNSå°é”æ¸…å•**
2. ç‚¹å‡» **æ·»åŠ é˜»æ­¢åˆ—è¡¨**
3. ç²˜è´´ä¸Šæ–¹RAWé“¾æŽ¥
4. è®¾ç½®é€‚å½“çš„æ›´æ–°é—´éš”ï¼ˆå»ºè®®24å°æ—¶ï¼‰

## ðŸ”„ åŒæ­¥çŠ¶æ€

**æœ€åŽåŒæ­¥æ—¶é—´:** $CURRENT_TIME  
**ä¸‹æ¬¡åŒæ­¥:** $NEXT_SYNC  
**ä»“åº“æ´»è·ƒçŠ¶æ€:** âœ… æ­£å¸¸  

## ðŸ“Š è§„åˆ™ç»Ÿè®¡

| è§„åˆ™ | æœ€åŽæ›´æ–° | æ¡ç›®æ•° |
|------|----------|--------|
| pro.mini.txt | $CURRENT_TIME | $PRO_COUNT |
| tif.medium.txt | $CURRENT_TIME | $TIF_COUNT |
| spam-tlds.txt | $CURRENT_TIME | $SPAM_COUNT |

## âš™ï¸ æŠ€æœ¯ç»†èŠ‚

- **åŒæ­¥é¢‘çŽ‡:** æ¯å°æ—¶ä¸€æ¬¡
- **å¤±è´¥é‡è¯•:** 3æ¬¡
- **ç›‘æŽ§:** GitHub Actionsè‡ªåŠ¨ç›‘æŽ§

---
*è‡ªåŠ¨åŒæ­¥è‡ª [HaGeZi's DNS Blocklists](https://github.com/hagezi/dns-blocklists)*
EOF
            echo "README.md å·²åˆ›å»º"
          fi
          
          # 4. æ›´æ–°çŠ¶æ€æ–‡ä»¶ï¼ˆç”¨äºŽæ—¥å¿—ï¼‰
          echo "æ›´æ–°çŠ¶æ€æ–‡ä»¶..."
          cat > sync-status.txt << EOF
æœ€åŽåŒæ­¥: $CURRENT_TIME
ä¸‹æ¬¡åŒæ­¥: $NEXT_SYNC

è§„åˆ™ç»Ÿè®¡:
- pro.mini.txt: $PRO_COUNT æ¡
- tif.medium.txt: $TIF_COUNT æ¡  
- spam-tlds.txt: $SPAM_COUNT æ¡

ç”ŸæˆäºŽ: $CURRENT_TIME
EOF
          
          # 5. è®°å½•æ—¥å¿—
          echo "Sync completed at $(date)" >> logs/sync-$(date +%Y-%m-%d).log
          
          # 6. è®¾ç½®è¾“å‡ºå˜é‡ï¼Œç”¨äºŽåŽç»­æ­¥éª¤åˆ¤æ–­
          if [[ "$any_rule_updated" = true ]]; then
            echo "æœ‰è§„åˆ™æ›´æ–°ï¼Œéœ€è¦æäº¤"
            echo "update_type=rules_and_status" >> $GITHUB_OUTPUT
          else
            echo "ä»…çŠ¶æ€ä¿¡æ¯æ›´æ–°ï¼Œéœ€è¦æäº¤"
            echo "update_type=status_only" >> $GITHUB_OUTPUT
          fi

      # ========== å…³é”®ä¿®å¤åœ¨æ­¤å¤„ ==========
      - name: Commit and Push Changes
        if: ${{ steps.sync.outputs.update_type != '' }}
        run: |
          echo "å‡†å¤‡æäº¤æ›´æ”¹..."
          
          # é…ç½®git
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹çš„æ–‡ä»¶
          git add rules/ README.md sync-status.txt logs/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            # æ ¹æ®æ›´æ–°ç±»åž‹ç”Ÿæˆæäº¤ä¿¡æ¯
            UPDATE_TYPE="${{ steps.sync.outputs.update_type }}"
            if [[ "$UPDATE_TYPE" == "rules_and_status" ]]; then
              commit_msg="ðŸ¤– åŒæ­¥è§„åˆ™å¹¶æ›´æ–°çŠ¶æ€ - $(date -u +'%Y-%m-%d %H:%M')"
            else
              commit_msg="ðŸ“Š æ›´æ–°åŒæ­¥çŠ¶æ€ - $(date -u +'%Y-%m-%d %H:%M')"
            fi
            
            # æäº¤å¹¶æŽ¨é€
            git commit -m "$commit_msg"
            git push
            echo "æ›´æ”¹å·²æäº¤å¹¶æŽ¨é€ã€‚"
          fi

      - name: Generate Summary Report
        if: always()
        run: |
          echo "## ðŸ“Š åŒæ­¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ -f "sync-status.txt" ]]; then
            # ä»ŽçŠ¶æ€æ–‡ä»¶è¯»å–ä¿¡æ¯
            LAST_SYNC=$(grep "æœ€åŽåŒæ­¥:" sync-status.txt | cut -d':' -f2- | xargs)
            NEXT_SYNC=$(grep "ä¸‹æ¬¡åŒæ­¥:" sync-status.txt | cut -d':' -f2- | xargs)
            PRO_COUNT=$(grep "pro.mini.txt:" sync-status.txt | grep -o '[0-9]\+' | head -1)
            TIF_COUNT=$(grep "tif.medium.txt:" sync-status.txt | grep -o '[0-9]\+' | head -1)
            SPAM_COUNT=$(grep "spam-tlds.txt:" sync-status.txt | grep -o '[0-9]\+' | head -1)
            
            echo "- **æœ€åŽåŒæ­¥:** $LAST_SYNC" >> $GITHUB_STEP_SUMMARY
            echo "- **ä¸‹æ¬¡åŒæ­¥:** $NEXT_SYNC" >> $GITHUB_STEP_SUMMARY
            echo "- **Pro Mini è§„åˆ™:** $PRO_COUNT æ¡" >> $GITHUB_STEP_SUMMARY
            echo "- **TIF Medium è§„åˆ™:** $TIF_COUNT æ¡" >> $GITHUB_STEP_SUMMARY
            echo "- **Spam TLDs:** $SPAM_COUNT æ¡" >> $GITHUB_STEP_SUMMARY
            
            # å®‰å…¨åœ°èŽ·å–æ›´æ–°ç±»åž‹
            UPDATE_TYPE="${{ steps.sync.outputs.update_type }}"
            if [[ -z "$UPDATE_TYPE" ]]; then
              UPDATE_TYPE="æœªæ£€æµ‹åˆ°æ›´æ”¹"
            fi
            echo "- **æ›´æ–°ç±»åž‹:** $UPDATE_TYPE" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ çŠ¶æ€æ–‡ä»¶æœªç”Ÿæˆï¼ŒåŒæ­¥å¯èƒ½å¤±è´¥ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
